{% extends 'base.html' %}

{% block title %}All Reports - SIRMS{% endblock %}

{% block content %}
<style>
    .compact-table {
        font-size: 12px;
        line-height: 1.4;
    }
    .compact-table th {
        padding: 6px 8px !important;
        font-size: 11px !important;
        white-space: nowrap;
        position: sticky;
        top: 0;
        background-color: #f9fafb;
        z-index: 10;
        font-weight: 600;
    }
    .compact-table td {
        padding: 5px 8px !important;
        font-size: 12px !important;
        vertical-align: top;
        line-height: 1.4;
    }
    .compact-table .text-xs {
        font-size: 10px !important;
    }
    .compact-table .text-sm {
        font-size: 11px !important;
    }
    .compact-badge {
        padding: 2px 5px !important;
        font-size: 10px !important;
        line-height: 1.3;
    }
    .compact-icon {
        font-size: 11px !important;
    }
    .table-container {
        max-height: calc(100vh - 220px);
        overflow-y: auto;
        overflow-x: auto;
    }
    .max-w-\[98vw\] {
        max-width: 98vw;
    }
    .report-row {
        height: auto;
        min-height: 50px;
    }
    .stats-card {
        padding: 8px !important;
    }
    .stats-card .text-lg {
        font-size: 18px !important;
    }
    .stats-card .text-xs {
        font-size: 10px !important;
    }
</style>
<div class="max-w-[98vw] mx-auto">
    <!-- Clickable Statistics Cards -->
    <div class="grid grid-cols-4 gap-2 mb-2">
        <!-- Top 5 Most Reported Students/Teachers -->
        <button onclick="showTop5TrendsModal()" 
           class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded shadow border border-purple-400 stats-card text-center hover:shadow-md transition-all cursor-pointer text-white">
            <div class="text-lg font-bold">
                <i class="fas fa-chart-line"></i> Top 5
            </div>
            <div class="text-white text-xs font-semibold">Most Reported</div>
        </button>
        
        <!-- Top 5 Most Reported Incidents -->
        <button onclick="showTop5IncidentsModal()" 
           class="bg-gradient-to-br from-orange-500 to-red-600 rounded shadow border border-orange-400 stats-card text-center hover:shadow-md transition-all cursor-pointer text-white">
            <div class="text-lg font-bold">
                <i class="fas fa-exclamation-triangle"></i> Top 5
            </div>
            <div class="text-white text-xs font-semibold">Most Incident Report</div>
        </button>
        
        <!-- Total Reports -->
        <a href="{% url 'all_reports' %}" 
           class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded shadow border border-blue-400 stats-card text-center hover:shadow-md transition-all cursor-pointer text-white">
            <div class="text-lg font-bold">{{ total_count|default:0 }}</div>
            <div class="text-white text-xs font-semibold">Total Reports</div>
        </a>
        
        <!-- Repeat Violators -->
        <a href="{% url 'all_reports' %}?repeat_offender=true" 
           class="bg-gradient-to-br from-red-500 to-pink-600 rounded shadow border border-red-400 stats-card text-center hover:shadow-md transition-all cursor-pointer text-white">
            <div class="text-lg font-bold">{{ repeat_offender_count|default:0 }}</div>
            <div class="text-white text-xs font-semibold">Repeat Violators</div>
        </a>
    </div>

    <div class="bg-white rounded shadow-sm border">
        <div class="p-3 border-b">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h2 class="text-base font-bold text-gray-900">All Reports ({{ reports|length }})</h2>
                    {% if is_repeat_filter_active %}
                    <div class="mt-1">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-800 border border-red-400">
                            <i class="fas fa-filter mr-1"></i>Repeat Only
                            <a href="{% url 'all_reports' %}" class="ml-1 text-red-600 hover:text-red-800">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    </div>
                    {% endif %}
                </div>
                <a href="{% url 'export_all_reports_excel' %}"
                    class="inline-flex items-center px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition-colors text-xs">
                    <i class="fas fa-file-excel mr-1"></i>
                    Export to Excel
                </a>
            </div>

            <!-- Search and Filters -->
            <div class="flex space-x-2 flex-wrap gap-2">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="searchInput" placeholder="ðŸ” Search by Case ID, Name, LRN..."
                        class="w-full px-2 py-1.5 border border-gray-300 rounded text-xs" onkeyup="filterReports()">
                </div>
                <select id="filter-status" class="px-2 py-1.5 border border-gray-300 rounded text-xs"
                    onchange="filterReports()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="under_review">Under Review</option>
                    <option value="classified">Classified</option>
                    <option value="evaluated">Evaluated</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <select id="filter-type" class="px-2 py-1.5 border border-gray-300 rounded text-xs"
                    onchange="filterReports()">
                    <option value="">All Types</option>
                    <option value="prohibited">Prohibited</option>
                    <option value="school_policy">Policy</option>
                </select>
                <select id="filter-grade" class="px-2 py-1.5 border border-gray-300 rounded text-xs"
                    onchange="filterReports()">
                    <option value="">All Grades</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
                <select id="filter-reporter" class="px-2 py-1.5 border border-gray-300 rounded text-xs"
                    onchange="filterReports()">
                    <option value="">All Reporters</option>
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                    <option value="do">DO</option>
                    <option value="counselor">Counselor</option>
                </select>
                <select id="filter-repeat" class="px-2 py-1.5 border border-gray-300 rounded text-xs bg-red-50"
                    onchange="filterReports()">
                    <option value="">All</option>
                    <option value="repeat">Repeat Only</option>
                </select>
            </div>
        </div>

        {% if reports %}
        <div class="table-container overflow-x-auto">
            <table class="min-w-full compact-table">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                        <th class="text-left font-medium text-gray-500 uppercase">Case ID</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Involved</th>
                        <th class="text-left font-medium text-gray-500 uppercase">ID/LRN</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Academic</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Reporter</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Reporter ID</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Reporter Academic</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Incident</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Date/Time</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Status</th>
                        <th class="text-left font-medium text-gray-500 uppercase">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="reports-table">
                    {% for report in reports %}
                    <tr class="hover:bg-gray-50 report-row border-l-2 {% if report.is_repeat_offender %}border-red-500{% elif report.status == 'pending' %}border-yellow-400{% elif report.status == 'under_review' %}border-blue-400{% elif report.status == 'classified' %}border-purple-400{% elif report.status == 'resolved' %}border-green-400{% else %}border-gray-300{% endif %} {% if report.is_repeat_offender %}bg-red-50{% endif %}" 
                        data-status="{{ report.status }}"
                        data-type="{% if report.incident_type %}{{ report.incident_type.severity }}{% endif %}"
                        data-grade="{{ report.grade_level }}"
                        data-reporter="{% if report.reporter %}{{ report.reporter.role }}{% endif %}"
                        data-repeat="{% if report.is_repeat_offender %}repeat{% else %}normal{% endif %}"
                        data-search="{{ report.case_id|lower }} {% if report.reported_student %}{{ report.reported_student.get_full_name|lower }} {% if report.reported_student.lrn %}{{ report.reported_student.lrn }}{% endif %}{% endif %} {% if report.reported_teacher %}{{ report.reported_teacher.get_full_name|lower }} {% if report.reported_teacher.employee_id %}{{ report.reported_teacher.employee_id }}{% endif %}{% endif %} {% if report.reporter %}{{ report.reporter.get_full_name|lower }} {% if report.reporter.lrn %}{{ report.reporter.lrn }}{% endif %} {% if report.reporter.employee_id %}{{ report.reporter.employee_id }}{% endif %}{% endif %} {% if report.involved_students %}{{ report.involved_students|lower }}{% endif %}">
                        
                        <!-- Case ID -->
                        <td>
                            <div class="font-bold text-blue-600">{{ report.case_id }}</div>
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-calendar"></i> {{ report.created_at|date:"M d" }}
                            </div>
                            {% if report.report_type %}
                            <span class="compact-badge rounded {% if report.report_type == 'violation' %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-700{% endif %} font-medium">
                                {{ report.report_type|title|slice:":3" }}
                            </span>
                            {% endif %}
                        </td>
                        
                        <!-- Involved Party -->
                        <td>
                            <div class="font-semibold text-gray-900">
                                {% if report.involved_parties.exists %}
                                    {% for party in report.involved_parties.all|slice:":2" %}
                                        {% if party.party_type == 'student' %}
                                            {% if report.reported_student %}
                                                <i class="fas fa-user-graduate text-blue-500"></i> {{ report.reported_student.get_full_name|truncatewords:2 }}
                                            {% else %}
                                                <i class="fas fa-user-graduate text-blue-500"></i> {{ party.student_name|truncatewords:2 }}
                                            {% endif %}
                                        {% elif party.party_type == 'teacher' %}
                                            <i class="fas fa-chalkboard-teacher text-purple-500"></i> {{ party.teacher_name|truncatewords:2 }}
                                        {% endif %}
                                        {% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                {% elif report.reported_student %}
                                    <div class="flex items-center flex-wrap gap-1">
                                        <i class="fas fa-user-graduate text-blue-500"></i>
                                        <span class="truncate max-w-[100px]" title="{{ report.reported_student.get_full_name }}">{{ report.reported_student.get_full_name|truncatewords:2 }}</span>
                                        {% if report.is_repeat_offender %}
                                        <span class="compact-badge rounded-full bg-red-100 text-red-800 border border-red-400" title="Repeat Ã—{{ report.total_reports_for_student|default:report.repeat_count|add:1 }}">
                                            <i class="fas fa-exclamation-triangle"></i>Ã—{{ report.total_reports_for_student|default:report.repeat_count|add:1 }}
                                        </span>
                                        {% endif %}
                                    </div>
                                {% elif report.reported_teacher %}
                                    <i class="fas fa-chalkboard-teacher text-purple-500"></i> {{ report.reported_teacher.get_full_name|truncatewords:2 }}
                                {% elif report.involved_students %}
                                    <i class="fas fa-users text-blue-500"></i> {{ report.involved_students|truncatewords:3 }}
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </div>
                            {% if report.student_gender %}
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-venus-mars"></i> {{ report.student_gender|title|slice:":1" }}
                            </div>
                            {% endif %}
                        </td>
                        
                        <!-- Involved Party LRN/Employee ID -->
                        <td>
                            <div class="font-medium text-gray-900">
                                {% if report.reported_student %}
                                    {% if report.reported_student.lrn %}
                                        <div class="flex items-center">
                                            <i class="fas fa-id-card text-blue-500"></i>
                                            <span class="font-mono text-xs" title="{{ report.reported_student.lrn }}">{{ report.reported_student.lrn|slice:":10" }}...</span>
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400 text-xs">-</span>
                                    {% endif %}
                                {% elif report.reported_teacher %}
                                    {% if report.reported_teacher.employee_id %}
                                        <div class="flex items-center">
                                            <i class="fas fa-id-badge text-purple-500"></i>
                                            <span class="font-mono text-xs" title="{{ report.reported_teacher.employee_id }}">{{ report.reported_teacher.employee_id|truncatewords:1 }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400 text-xs">-</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400 text-xs">-</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Involved Party Academic Info -->
                        <td>
                            <div class="text-gray-900">
                                {% if report.grade_level %}
                                <span class="text-xs font-semibold">G{{ report.grade_level }}</span>
                                {% if report.section_name %}
                                <span class="text-xs text-gray-600">-{{ report.section_name|slice:":5" }}</span>
                                {% endif %}
                                {% endif %}
                                {% if report.track_code %}
                                <div class="text-xs text-gray-500">{{ report.track_code }}</div>
                                {% endif %}
                                {% if not report.grade_level %}
                                <span class="text-gray-400 text-xs">-</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Reporter Name -->
                        <td>
                            <div class="font-medium text-gray-900">
                                {% if report.reporter %}
                                    <i class="fas fa-user-edit text-green-500"></i> {{ report.reporter.get_full_name|truncatewords:2 }}
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </div>
                            {% if report.reporter %}
                            <div>
                                {% if report.reporter.role == 'student' %}
                                <span class="compact-badge rounded bg-blue-100 text-blue-700 font-medium">Student</span>
                                {% elif report.reporter.role == 'teacher' %}
                                <span class="compact-badge rounded bg-purple-100 text-purple-700 font-medium">Teacher</span>
                                {% elif report.reporter.role == 'do' %}
                                <span class="compact-badge rounded bg-emerald-100 text-emerald-700 font-medium">DO</span>
                                {% elif report.reporter.role == 'counselor' %}
                                <span class="compact-badge rounded bg-teal-100 text-teal-700 font-medium">Counselor</span>
                                {% else %}
                                <span class="compact-badge rounded bg-gray-100 text-gray-700 font-medium">{{ report.reporter.role|title }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if report.reporter_is_victim %}
                            <div class="text-xs text-red-600">
                                <i class="fas fa-user-injured"></i> Victim
                            </div>
                            {% endif %}
                        </td>
                        
                        <!-- Reporter LRN/Employee ID -->
                        <td>
                            <div class="font-medium text-gray-900">
                                {% if report.reporter %}
                                    {% if report.reporter.role == 'student' and report.reporter.lrn %}
                                        <div class="flex items-center">
                                            <i class="fas fa-id-card text-blue-500"></i>
                                            <span class="font-mono text-xs" title="{{ report.reporter.lrn }}">{{ report.reporter.lrn|slice:":10" }}...</span>
                                        </div>
                                    {% elif report.reporter.role != 'student' and report.reporter.employee_id %}
                                        <div class="flex items-center">
                                            <i class="fas fa-id-badge text-purple-500"></i>
                                            <span class="font-mono text-xs" title="{{ report.reporter.employee_id }}">{{ report.reporter.employee_id|truncatewords:1 }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400 text-xs">-</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400 text-xs">-</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Reporter Academic Info -->
                        <td>
                            <div class="text-gray-900">
                                {% if report.reporter %}
                                    {% if report.reporter.role == 'student' %}
                                        {% if report.reporter.grade_level %}
                                        <span class="text-xs font-semibold">G{{ report.reporter.grade_level }}</span>
                                        {% if report.reporter.section %}
                                        <span class="text-xs text-gray-600">-{{ report.reporter.section|slice:":5" }}</span>
                                        {% endif %}
                                        {% endif %}
                                        {% if report.reporter.track_code %}
                                        <div class="text-xs text-gray-500">{{ report.reporter.track_code }}</div>
                                        {% endif %}
                                        {% if not report.reporter.grade_level %}
                                        <span class="text-gray-400 text-xs">-</span>
                                        {% endif %}
                                    {% elif report.reporter.role == 'teacher' %}
                                        {% if report.reporter.department %}
                                        <div class="text-xs font-medium">{{ report.reporter.department|truncatewords:1 }}</div>
                                        {% else %}
                                        <span class="text-gray-400 text-xs">-</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-gray-400 text-xs">-</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400 text-xs">-</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Incident Details -->
                        <td>
                            {% if report.incident_type %}
                                <div class="font-semibold text-gray-900" title="{{ report.incident_type.name }}">{{ report.incident_type.name|truncatewords:4 }}</div>
                                <div>
                                    {% if report.incident_type.severity == 'prohibited' %}
                                    <span class="compact-badge rounded-full bg-red-100 text-red-700 font-semibold">
                                        <i class="fas fa-ban"></i> Prohibited
                                    </span>
                                    {% elif report.incident_type.severity == 'school_policy' %}
                                    <span class="compact-badge rounded-full bg-blue-100 text-blue-700 font-semibold">
                                        <i class="fas fa-clipboard-list"></i> Policy
                                    </span>
                                    {% endif %}
                                </div>
                                {% if report.violation_code %}
                                <div class="text-xs text-gray-600">
                                    <i class="fas fa-hashtag"></i> {{ report.violation_code }}
                                </div>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                            {% if report.description %}
                            <div class="text-xs text-gray-600 max-w-[150px] truncate" title="{{ report.description }}">
                                <i class="fas fa-align-left"></i> {{ report.description|truncatewords:10 }}
                            </div>
                            {% endif %}
                            {% if report.bullying_type %}
                            <div class="text-xs text-orange-600">
                                <i class="fas fa-exclamation-triangle"></i> {{ report.bullying_type|truncatewords:1 }}
                            </div>
                            {% endif %}
                        </td>
                        
                        <!-- Date & Time -->
                        <td>
                            <div class="text-gray-900">
                                <i class="fas fa-calendar-day"></i> {{ report.incident_date|date:"M d" }}
                            </div>
                            {% if report.incident_time %}
                            <div class="text-xs text-gray-600">
                                <i class="fas fa-clock"></i> {{ report.incident_time|time:"H:i" }}
                            </div>
                            {% else %}
                            <div class="text-xs text-gray-400">-</div>
                            {% endif %}
                        </td>
                        
                        <!-- Status & Actions -->
                        <td>
                            <div class="space-y-1">
                                <!-- Status Badge -->
                                {% if report.status == 'pending' %}
                                <span class="inline-flex items-center compact-badge rounded-full bg-yellow-100 text-yellow-800 font-semibold">
                                    <i class="fas fa-clock"></i> Pending
                                </span>
                                {% elif report.status == 'under_review' %}
                                <span class="inline-flex items-center compact-badge rounded-full bg-blue-100 text-blue-800 font-semibold">
                                    <i class="fas fa-search"></i> Review
                                </span>
                                {% elif report.status == 'classified' %}
                                <span class="inline-flex items-center compact-badge rounded-full bg-purple-100 text-purple-800 font-semibold">
                                    <i class="fas fa-tags"></i> Classified
                                </span>
                                {% elif report.status == 'evaluated' %}
                                <span class="inline-flex items-center compact-badge rounded-full bg-indigo-100 text-indigo-800 font-semibold">
                                    <i class="fas fa-check-circle"></i> Evaluated
                                </span>
                                {% elif report.status == 'resolved' %}
                                <span class="inline-flex items-center compact-badge rounded-full bg-green-100 text-green-800 font-semibold">
                                    <i class="fas fa-check-double"></i> Resolved
                                </span>
                                {% elif report.status == 'closed' %}
                                <span class="inline-flex items-center compact-badge rounded-full bg-gray-100 text-gray-800 font-semibold">
                                    <i class="fas fa-lock"></i> Closed
                                </span>
                                {% endif %}
                                
                                <!-- Additional Indicators -->
                                {% if report.is_repeat_offender %}
                                <div>
                                    <span class="inline-flex items-center compact-badge rounded bg-red-100 text-red-800 border border-red-500" title="Ã—{{ report.total_reports_for_student|default:report.repeat_count|add:1 }}">
                                        <i class="fas fa-exclamation-triangle"></i> Ã—{{ report.total_reports_for_student|default:report.repeat_count|add:1 }}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if report.follow_up_required %}
                                <div>
                                    <span class="inline-flex items-center compact-badge rounded bg-orange-100 text-orange-800">
                                        <i class="fas fa-arrow-right"></i> Follow-up
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if report.evidence %}
                                <div>
                                    <span class="inline-flex items-center compact-badge rounded bg-green-100 text-green-800">
                                        <i class="fas fa-file-alt"></i> Evidence
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if report.is_confidential %}
                                <div>
                                    <span class="inline-flex items-center compact-badge rounded bg-red-100 text-red-800">
                                        <i class="fas fa-lock"></i> Confidential
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Action Button -->
                        <td>
                            <a href="{% url 'report_detail' report.case_id %}"
                                class="inline-flex items-center justify-center px-2 py-1.5 text-xs font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors"
                                title="View Full Report Details">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="text-gray-500">No reports to display</div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function filterReports() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('filter-status').value;
        const typeFilter = document.getElementById('filter-type').value;
        const gradeFilter = document.getElementById('filter-grade').value;
        const reporterFilter = document.getElementById('filter-reporter').value;
        const repeatFilter = document.getElementById('filter-repeat').value;
        const rows = document.querySelectorAll('.report-row');

        rows.forEach(row => {
            const searchText = row.getAttribute('data-search');
            const status = row.getAttribute('data-status');
            const type = row.getAttribute('data-type');
            const grade = row.getAttribute('data-grade');
            const reporter = row.getAttribute('data-reporter');
            const repeat = row.getAttribute('data-repeat');

            const searchMatch = !searchValue || searchText.includes(searchValue);
            const statusMatch = !statusFilter || status === statusFilter;
            const typeMatch = !typeFilter || type === typeFilter;
            const gradeMatch = !gradeFilter || grade === gradeFilter;
            const reporterMatch = !reporterFilter || reporter === reporterFilter;
            const repeatMatch = !repeatFilter || repeat === repeatFilter;

            if (searchMatch && statusMatch && typeMatch && gradeMatch && reporterMatch && repeatMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Top 5 Trends Modal Functions
    function showTop5TrendsModal() {
        document.getElementById('top5TrendsModal').classList.remove('hidden');
    }

    function closeTop5TrendsModal() {
        document.getElementById('top5TrendsModal').classList.add('hidden');
    }

    // Top 5 Incidents Modal Functions
    function showTop5IncidentsModal() {
        document.getElementById('top5IncidentsModal').classList.remove('hidden');
    }

    function closeTop5IncidentsModal() {
        document.getElementById('top5IncidentsModal').classList.add('hidden');
    }

    // Close modals when clicking outside
    window.addEventListener('load', function() {
        const trendsModal = document.getElementById('top5TrendsModal');
        const incidentsModal = document.getElementById('top5IncidentsModal');
        
        if (trendsModal) {
            trendsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTop5TrendsModal();
                }
            });
        }
        
        if (incidentsModal) {
            incidentsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTop5IncidentsModal();
                }
            });
        }
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTop5TrendsModal();
            closeTop5IncidentsModal();
        }
    });
</script>

<!-- Top 5 Trends Modal (Chat Heads Style) -->
<div id="top5TrendsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 text-white flex justify-between items-center">
            <h3 class="text-2xl font-bold">
                <i class="fas fa-chart-line mr-2"></i>Top 5 Most Reported Students/Teachers
            </h3>
            <button onclick="closeTop5TrendsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-100px)]">
            {% if top_5_trends %}
            <div class="space-y-4">
                {% for trend in top_5_trends %}
                <div class="bg-gradient-to-r from-gray-50 to-white rounded-lg border-2 border-gray-200 p-4 hover:shadow-lg transition-all">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-1">
                            <div class="flex-shrink-0">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br {% if trend.type == 'student' %}from-blue-400 to-blue-600{% else %}from-purple-400 to-purple-600{% endif %} flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                                    {% if trend.type == 'student' %}
                                        <i class="fas fa-user-graduate"></i>
                                    {% else %}
                                        <i class="fas fa-chalkboard-teacher"></i>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h4 class="text-lg font-bold text-gray-900">{{ trend.name }}</h4>
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold {% if trend.type == 'student' %}bg-blue-100 text-blue-700{% else %}bg-purple-100 text-purple-700{% endif %}">
                                        {{ trend.type|title }}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div>
                                        <i class="fas fa-id-card mr-2 text-gray-400"></i>
                                        <span class="font-mono">{{ trend.identifier }}</span>
                                    </div>
                                    {% if trend.grade %}
                                    <div>
                                        <i class="fas fa-graduation-cap mr-2 text-gray-400"></i>
                                        Grade {{ trend.grade }}{% if trend.section %} - {{ trend.section }}{% endif %}
                                    </div>
                                    {% endif %}
                                    <div class="mt-2">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-700 border-2 border-red-400">
                                            <i class="fas fa-chart-bar mr-2"></i>{{ trend.count }} Report{{ trend.count|pluralize }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            <div class="text-3xl font-bold text-gray-400">#{{ forloop.counter }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>No trends data available</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Top 5 Incidents Modal (Chat Heads Style) -->
<div id="top5IncidentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
        <div class="bg-gradient-to-r from-orange-600 to-red-600 px-6 py-4 text-white flex justify-between items-center">
            <h3 class="text-2xl font-bold">
                <i class="fas fa-exclamation-triangle mr-2"></i>Top 5 Most Incident Report
            </h3>
            <button onclick="closeTop5IncidentsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-100px)]">
            {% if top_5_incidents %}
            <div class="space-y-4">
                {% for incident in top_5_incidents %}
                <div class="bg-gradient-to-r from-gray-50 to-white rounded-lg border-2 border-gray-200 p-4 hover:shadow-lg transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-start space-x-4 flex-1">
                            <div class="flex-shrink-0">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br {% if incident.severity == 'prohibited' %}from-red-400 to-red-600{% else %}from-orange-400 to-orange-600{% endif %} flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h4 class="text-lg font-bold text-gray-900">{{ incident.name }}</h4>
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold {% if incident.severity == 'prohibited' %}bg-red-100 text-red-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                                        {{ incident.severity|title }}
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-700 border-2 border-red-400">
                                        <i class="fas fa-chart-bar mr-2"></i>{{ incident.count }} Report{{ incident.count|pluralize }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            <div class="text-3xl font-bold text-gray-400">#{{ forloop.counter }}</div>
                        </div>
                    </div>
                    
                    <!-- Recent Reports for this Incident -->
                    {% if incident.recent_reports %}
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <h5 class="text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-clock mr-1"></i>Recent Reports:
                        </h5>
                        <div class="space-y-2">
                            {% for report in incident.recent_reports %}
                            <div class="bg-gray-50 rounded p-2 text-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-semibold text-gray-900">{{ report.case_id }}</span>
                                        {% if report.reported_student %}
                                        <span class="text-gray-600 ml-2">
                                            <i class="fas fa-user-graduate mr-1"></i>{{ report.reported_student.get_full_name }}
                                        </span>
                                        {% elif report.reported_teacher %}
                                        <span class="text-gray-600 ml-2">
                                            <i class="fas fa-chalkboard-teacher mr-1"></i>{{ report.reported_teacher.get_full_name }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'report_detail' report.case_id %}" 
                                       class="text-blue-600 hover:text-blue-800 text-xs">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </a>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-calendar mr-1"></i>{{ report.created_at|date:"M d, Y" }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>No incidents data available</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}