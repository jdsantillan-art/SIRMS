{% extends 'base.html' %}

{% block title %}Fact-Check Reports - SIRMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm border border-green-200">
        <div class="p-3 border-b border-green-200 bg-green-50">
            <h2 class="text-lg font-bold text-green-900"><i class="fas fa-clipboard-check mr-2"></i>Pending Reports for Verification</h2>
        </div>

        {% if reports_with_students %}
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-green-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Case ID</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Student Involved</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Academic Info</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Incident Type</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Description</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Reporter</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Date/Time</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in reports_with_students %}
                    {% with report=item.report %}
                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                        <td class="px-3 py-3">
                            <div class="text-sm font-bold text-blue-600">{{ report.case_id }}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-clock mr-1"></i>{{ report.created_at|date:"M d, Y" }}
                            </div>
                        </td>
                        <td class="px-3 py-3">
                            {% if item.involved_student_name %}
                            <div class="text-sm font-medium text-gray-900">{{ item.involved_student_name }}</div>
                            {% if report.reported_student %}
                                {% if report.reported_student.lrn %}
                                <div class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-id-card mr-1"></i>LRN: {{ report.reported_student.lrn }}
                                </div>
                                {% endif %}
                            {% endif %}
                            {% elif report.involved_students %}
                            <div class="text-xs text-gray-600">{{ report.involved_students|truncatewords:5 }}</div>
                            <div class="text-xs text-orange-600 mt-1">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Not identified
                            </div>
                            {% else %}
                            <div class="text-xs text-gray-400">Not specified</div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3">
                            {% if report.curriculum %}
                            <div class="text-xs text-gray-700">
                                <div class="font-semibold">{{ report.curriculum.name }}</div>
                                {% if report.track_code %}
                                <div class="text-gray-600 mt-1">Track: {{ report.track_code }}</div>
                                {% endif %}
                                {% if report.grade_level %}
                                <div class="text-gray-600">Grade {{ report.grade_level }}</div>
                                {% endif %}
                                {% if report.section_name %}
                                <div class="text-gray-600">Section: {{ report.section_name }}</div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="text-xs text-gray-400">Not specified</div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3">
                            {% if report.incident_type %}
                            <div class="text-sm font-medium text-gray-900">{{ report.incident_type.name }}</div>
                            {% if report.incident_type.severity == 'prohibited' %}
                            <span class="inline-flex items-center px-2 py-0.5 mt-1 text-xs rounded-full bg-red-100 text-red-800 font-semibold">
                                <i class="fas fa-exclamation-circle mr-1"></i>Prohibited Act
                            </span>
                            {% elif report.incident_type.severity == 'school_policy' %}
                            <span class="inline-flex items-center px-2 py-0.5 mt-1 text-xs rounded-full bg-blue-100 text-blue-800 font-semibold">
                                <i class="fas fa-info-circle mr-1"></i>School Policy
                            </span>
                            {% endif %}
                            {% else %}
                            <div class="text-xs text-gray-400">Not specified</div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3 max-w-xs">
                            {% if report.description %}
                            <div class="text-xs text-gray-700 line-clamp-2" title="{{ report.description }}">
                                {{ report.description|truncatewords:15 }}
                            </div>
                            {% if report.description|length > 100 %}
                            <button onclick="showDescriptionModal('{{ report.case_id }}', '{{ report.description|escapejs }}')" 
                                class="text-xs text-blue-600 hover:underline mt-1">
                                Read more...
                            </button>
                            {% endif %}
                            {% else %}
                            <div class="text-xs text-gray-400">No description</div>
                            {% endif %}
                            {% if report.immediate_actions_taken %}
                            <div class="text-xs text-green-700 mt-1">
                                <i class="fas fa-check-circle mr-1"></i>Actions taken
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3">
                            <div class="text-sm font-medium text-gray-900">{{ report.reporter.get_full_name }}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                {% if report.reporter.role == 'student' %}
                                    <i class="fas fa-user-graduate mr-1"></i>Student
                                {% elif report.reporter.role == 'teacher' %}
                                    <i class="fas fa-chalkboard-teacher mr-1"></i>Teacher
                                {% elif report.reporter.role == 'admin' %}
                                    <i class="fas fa-user-shield mr-1"></i>Admin
                                {% else %}
                                    {{ report.reporter.get_role_display }}
                                {% endif %}
                            </div>
                            {% if report.reporter_contact %}
                            <div class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-phone mr-1"></i>{{ report.reporter_contact }}
                            </div>
                            {% endif %}
                            {% if report.reporter_is_victim %}
                            <span class="inline-flex items-center px-1.5 py-0.5 mt-1 rounded text-xs font-semibold bg-red-100 text-red-800">
                                <i class="fas fa-user-injured mr-1"></i>Victim
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3">
                            <div class="text-sm font-medium text-gray-900">
                                <i class="fas fa-calendar-day mr-1"></i>{{ report.incident_date|date:"M d, Y" }}
                            </div>
                            {% if report.incident_time %}
                            <div class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-clock mr-1"></i>{{ report.incident_time|time:"g:i A" }}
                            </div>
                            {% endif %}
                            <div class="text-xs text-gray-500 mt-1">
                                Reported: {{ report.created_at|timesince }} ago
                            </div>
                        </td>
                        <td class="px-3 py-3">
                            <span class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 font-semibold">
                                <i class="fas fa-hourglass-half mr-1"></i>Pending
                            </span>
                            {% if report.evidence %}
                            <div class="text-xs text-blue-600 mt-1">
                                <i class="fas fa-paperclip mr-1"></i>Evidence attached
                            </div>
                            {% endif %}
                            {% if report.witnesses.exists %}
                            <div class="text-xs text-purple-600 mt-1">
                                <i class="fas fa-users mr-1"></i>{{ report.witnesses.count }} witness{{ report.witnesses.count|pluralize:"es" }}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3">
                            <div class="flex flex-col space-y-1">
                                <a href="{% url 'report_detail' report.case_id %}"
                                    class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700 transition-colors"
                                    title="View Full Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button
                                    class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700 transition-colors"
                                    onclick="showClassifyModal('{{ report.id }}', '{{ report.case_id }}', {% if item.involved_student_id %}'{{ item.involved_student_id }}', '{{ item.involved_student_name|escapejs }}'{% else %}null, null{% endif %}, {% if item.raw_student_name %}'{{ item.raw_student_name|escapejs }}'{% else %}null{% endif %})"
                                    title="Verify & Classify">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}
        <div class="text-center py-8">
            <div class="text-4xl mb-2">✅</div>
            <div class="text-gray-500 text-sm">No reports pending fact-check</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Description Modal -->
<div id="descriptionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-4 border w-full max-w-2xl shadow-2xl rounded-xl bg-white max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-3 pb-2 border-b">
            <h3 class="text-base font-bold text-gray-900 flex items-center">
                <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                Incident Description - <span id="descriptionCaseId" class="ml-2"></span>
            </h3>
            <button onclick="hideDescriptionModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
            <p id="descriptionContent" class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap"></p>
        </div>
        <div class="mt-4 flex justify-end">
            <button onclick="hideDescriptionModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm font-semibold">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Classification Modal -->
<div id="classifyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-4 border w-full max-w-2xl shadow-2xl rounded-xl bg-white max-h-[90vh] overflow-y-auto">
        <div>
            <div class="flex justify-between items-center mb-3 pb-2 border-b">
                <h3 class="text-base font-bold text-gray-900 flex items-center">
                    <i class="fas fa-clipboard-check text-emerald-600 mr-2"></i>
                    Verify & Classify Report
                </h3>
                <button onclick="hideClassifyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form method="post" id="classifyForm" onsubmit="return validateFactCheckForm()">
                {% csrf_token %}
                <input type="hidden" name="report_id" id="modalReportId">
                <input type="hidden" name="action" value="verify">

                <!-- Evidence Status Section -->
                <div class="mb-3 p-2 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <label class="block text-xs font-bold text-gray-800 mb-1">
                        Evidence Status <span class="text-red-500">*</span>
                    </label>
                    <div class="space-y-1">
                        <label class="flex items-center p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                            <input type="radio" name="evidence_status" value="clear" class="mr-2 w-3 h-3" checked required>
                            <div class="text-xs">
                                <span class="font-semibold text-emerald-700">✅ Clear</span>
                                <span class="text-gray-600"> - Sufficient evidence</span>
                            </div>
                        </label>
                        <label class="flex items-center p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                            <input type="radio" name="evidence_status" value="insufficient" class="mr-2 w-3 h-3" required>
                            <div class="text-xs">
                                <span class="font-semibold text-orange-700">⚠️ Insufficient</span>
                                <span class="text-gray-600"> - Need more evidence</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Evidence Notes (shown when insufficient) -->
                <div class="mb-3" id="evidenceNotesSection" style="display: none;">
                    <label class="block text-xs font-bold text-gray-800 mb-1">
                        Reason <span class="text-red-500">*</span>
                    </label>
                    <textarea name="evidence_notes" id="evidenceNotesField" rows="2"
                        class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-orange-500 outline-none"
                        placeholder="What additional evidence is needed?"></textarea>
                </div>

                <!-- Classification Section (shown when evidence is clear) -->
                <div id="classificationSection">
                    <!-- Student Assignment -->
                    <div class="mb-3 p-2 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                        <label class="block text-xs font-bold text-gray-800 mb-1">
                            Student Involved <span class="text-red-500">*</span>
                        </label>
                        
                        <!-- Show assigned student -->
                        <div id="assignedStudentDisplay" style="display: none;">
                            <div class="flex items-center justify-between p-2 bg-green-50 border border-green-200 rounded">
                                <div>
                                    <div class="text-sm font-semibold text-green-800" id="assignedStudentName"></div>
                                    <div class="text-xs text-green-600">Already assigned</div>
                                </div>
                                <button type="button" onclick="changeStudent()" class="text-xs text-blue-600 hover:underline">
                                    Change
                                </button>
                            </div>
                            <input type="hidden" name="student_id" id="assignedStudentId">
                        </div>
                        
                        <!-- Show search box -->
                        <div id="studentSearchBox">
                            <input type="text" id="studentSearch" list="studentList" 
                                class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-yellow-500 outline-none mb-2"
                                placeholder="Search student name..."
                                onchange="updateStudentId(this.value)">
                            <input type="hidden" name="student_id" id="selectedStudentId">
                            <datalist id="studentList">
                                {% for student in students %}
                                <option value="{{ student.get_full_name }}" data-id="{{ student.id }}" data-name="{{ student.get_full_name }}">
                                {% endfor %}
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="mb-3 p-2 bg-emerald-50 border-l-4 border-emerald-500 rounded">
                        <label class="block text-xs font-bold text-gray-800 mb-1">
                            Commission Level <span class="text-red-500">*</span>
                        </label>
                        <div class="space-y-1">
                            <label class="flex items-start p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                                <input type="radio" name="severity" value="first_commission" id="severityField" class="mr-2 mt-0.5 w-3 h-3" required>
                                <div class="text-xs">
                                    <div class="font-semibold text-blue-700">⚖️ First Commission</div>
                                    <div class="text-gray-600">Routes to Behavior Concerns (DO handles)</div>
                                </div>
                            </label>
                            <label class="flex items-start p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                                <input type="radio" name="severity" value="second_commission" class="mr-2 mt-0.5 w-3 h-3" required>
                                <div class="text-xs">
                                    <div class="font-semibold text-purple-700">⚖️ Second Commission</div>
                                    <div class="text-gray-600">Routes to Referral Evaluation (Guidance handles)</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-800 mb-1">
                            Notes (Optional)
                        </label>
                        <textarea name="notes" rows="2"
                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-emerald-500 outline-none"
                            placeholder="Routing decision notes..."></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-2 border-t">
                    <button type="button"
                        class="bg-gray-500 text-white px-3 py-1.5 rounded hover:bg-gray-600 text-xs font-semibold"
                        onclick="hideClassifyModal()">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                        class="bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700 text-xs font-semibold">
                        <i class="fas fa-check mr-1"></i> Verify & Classify
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

    // Classification Modal Functions
    function showClassifyModal(reportId, caseId, studentId, studentName, rawStudentName) {
        document.getElementById('modalReportId').value = reportId;
        document.querySelector('#classifyModal h3 i').nextSibling.textContent = ` Verify & Classify Report - Case ${caseId}`;
        
        // Handle student display
        const assignedDisplay = document.getElementById('assignedStudentDisplay');
        const searchBox = document.getElementById('studentSearchBox');
        const studentSearch = document.getElementById('studentSearch');
        const selectedStudentId = document.getElementById('selectedStudentId');
        
        if (studentId && studentName) {
            // Student found from involved_students or involved_parties - auto-fill search field
            // Find the option in datalist that matches this student
            const datalist = document.getElementById('studentList');
            const options = datalist.querySelectorAll('option');
            let foundOption = null;
            
            for (let option of options) {
                const optionId = option.getAttribute('data-id');
                if (optionId === studentId) {
                    foundOption = option.value;
                    break;
                }
            }
            
            if (foundOption) {
                // Auto-fill the search field with the student name
                studentSearch.value = foundOption;
                selectedStudentId.value = studentId;
                // Show search box (not assigned display) so user can see and modify if needed
                assignedDisplay.style.display = 'none';
                searchBox.style.display = 'block';
            } else {
                // If not found in datalist, show as assigned
                document.getElementById('assignedStudentName').textContent = studentName;
                document.getElementById('assignedStudentId').value = studentId;
                assignedDisplay.style.display = 'block';
                searchBox.style.display = 'none';
            }
        } else if (rawStudentName) {
            // No matching student found, but we have a raw name from involved_students field
            // Display the name in the search field so DO can see it and search for the student
            studentSearch.value = rawStudentName;
            selectedStudentId.value = '';
            assignedDisplay.style.display = 'none';
            searchBox.style.display = 'block';
            // Focus on the search field to help user find the student
            setTimeout(() => {
                studentSearch.focus();
                // Try to trigger autocomplete/datalist
                studentSearch.dispatchEvent(new Event('input', { bubbles: true }));
            }, 100);
        } else {
            // No student - show search, hide assigned
            assignedDisplay.style.display = 'none';
            searchBox.style.display = 'block';
            studentSearch.value = '';
            selectedStudentId.value = '';
        }
        
        document.getElementById('classifyModal').classList.remove('hidden');
    }
    
    function changeStudent() {
        // Switch from assigned display to search box
        document.getElementById('assignedStudentDisplay').style.display = 'none';
        document.getElementById('studentSearchBox').style.display = 'block';
        document.getElementById('studentSearch').value = '';
        document.getElementById('selectedStudentId').value = '';
        document.getElementById('studentSearch').focus();
    }

    function hideClassifyModal() {
        document.getElementById('classifyModal').classList.add('hidden');
        document.getElementById('classifyForm').reset();
        // Reset visibility
        document.getElementById('classificationSection').style.display = 'block';
        document.getElementById('evidenceNotesSection').style.display = 'none';
        document.getElementById('severityField').required = true;
        document.getElementById('evidenceNotesField').required = false;
    }

    // Close modal when clicking outside
    document.getElementById('classifyModal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideClassifyModal();
        }
    });

    // Handle evidence status radio button changes
    document.addEventListener('DOMContentLoaded', function () {
        const evidenceRadios = document.querySelectorAll('input[name="evidence_status"]');
        const classificationSection = document.getElementById('classificationSection');
        const evidenceNotesSection = document.getElementById('evidenceNotesSection');
        const severityField = document.getElementById('severityField');
        const evidenceNotesField = document.getElementById('evidenceNotesField');
        const submitBtn = document.getElementById('submitBtn');

        evidenceRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'insufficient') {
                    // Show evidence notes, hide classification
                    classificationSection.style.display = 'none';
                    evidenceNotesSection.style.display = 'block';
                    severityField.required = false;
                    evidenceNotesField.required = true;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Request More Evidence';
                    submitBtn.className = 'bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm font-semibold';
                } else {
                    // Show classification, hide evidence notes
                    classificationSection.style.display = 'block';
                    evidenceNotesSection.style.display = 'none';
                    severityField.required = true;
                    evidenceNotesField.required = false;
                    submitBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Verify & Classify';
                    submitBtn.className = 'bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors text-sm font-semibold';
                }
            });
        });

        // Highlight new reports
        const newItems = document.querySelectorAll('.report-item:has(.bg-blue-100)');
        newItems.forEach(item => {
            item.style.animation = 'pulse 2s infinite';
        });
    });

    // Auto-refresh every 2 minutes to check for new reports
    setInterval(function () {
        // Uncomment the line below if you want auto-refresh
        // location.reload();
    }, 120000);
    
    // Student search and selection
    function updateStudentId(selectedValue) {
        const datalist = document.getElementById('studentList');
        const options = datalist.querySelectorAll('option');
        const hiddenInput = document.getElementById('selectedStudentId');
        
        // Find matching option and get its data-id
        for (let option of options) {
            if (option.value === selectedValue) {
                hiddenInput.value = option.getAttribute('data-id');
                return;
            }
        }
        
        // Also try partial match by name (in case format is slightly different)
        if (selectedValue) {
            for (let option of options) {
                const optionName = option.getAttribute('data-name');
                if (optionName && selectedValue.includes(optionName)) {
                    hiddenInput.value = option.getAttribute('data-id');
                    return;
                }
            }
        }
        
        // If no match, clear the hidden input
        hiddenInput.value = '';
    }
    
    // Alternative: Enhanced search with live filtering
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('studentSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                // The datalist will automatically filter options as user types
                // This is native HTML5 functionality
            });
        }
    });
    
    // Description Modal Functions
    function showDescriptionModal(caseId, description) {
        document.getElementById('descriptionCaseId').textContent = caseId;
        document.getElementById('descriptionContent').textContent = description;
        document.getElementById('descriptionModal').classList.remove('hidden');
    }
    
    function hideDescriptionModal() {
        document.getElementById('descriptionModal').classList.add('hidden');
    }
    
    // Close description modal when clicking outside
    document.getElementById('descriptionModal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideDescriptionModal();
        }
    });
    
    // Form validation
    function validateFactCheckForm() {
        const studentId = document.getElementById('selectedStudentId').value || document.getElementById('assignedStudentId').value;
        
        // Student must be selected
        if (!studentId) {
            alert('Please select a student from the search list.');
            return false;
        }
        
        return true;
    }
</script>

<style>
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    table th {
        position: sticky;
        top: 0;
        background-color: #f0fdf4;
        z-index: 10;
    }
    
    .report-item:hover {
        background-color: #f0fdf4;
        transition: background-color 0.2s;
    }
</style>

{% endblock %}