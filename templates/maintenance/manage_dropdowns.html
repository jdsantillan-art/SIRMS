{% extends 'base.html' %}
{% load static %}

{% block title %}Dropdown Management - SIRMS{% endblock %}

{% block content %}
<style>
    .dropdown-section {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
    }
    .dropdown-table {
        font-size: 0.875rem;
    }
    .dropdown-table th,
    .dropdown-table td {
        padding: 0.5rem;
    }
    .compact-input {
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
    }
</style>

<div class="max-w-7xl mx-auto px-4 py-4">
    <div class="mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-indigo-700 mb-1">⚙️ Dropdown Management</h1>
            <p class="text-gray-600 text-sm">Manage all system dropdown options</p>
        </div>
        <div class="text-sm text-gray-500">
            Total Options: <span class="font-bold text-indigo-600">{{ total_options }}</span>
        </div>
    </div>

    <!-- Compact Tabs -->
    <div class="bg-white rounded-lg shadow-md mb-4">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px overflow-x-auto">
                {% for cat in category_options %}
                <button onclick="showDropdownTab('{{ cat.code }}')" 
                        class="dropdown-tab-button px-4 py-2 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap {% if forloop.first %}active border-indigo-500 text-indigo-600{% endif %}"
                        data-tab="{{ cat.code }}">
                    {{ cat.label }}
                    <span class="ml-1 text-xs bg-gray-100 px-1.5 py-0.5 rounded">{{ cat.count }}</span>
                </button>
                {% endfor %}
            </nav>
        </div>

        <!-- Dropdown Content Tabs -->
        <div class="dropdown-section p-4">
            {% for cat in category_options %}
            <div id="tab-{{ cat.code }}" class="dropdown-tab-content {% if not forloop.first %}hidden{% endif %}" data-category="{{ cat.code }}">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-gray-800">{{ cat.label }}</h3>
                    <button onclick="openAddModal('{{ cat.code }}', '{{ cat.label }}')" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-sm flex items-center space-x-1">
                        <i class="fas fa-plus text-xs"></i>
                        <span>Add Option</span>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full dropdown-table divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-12">Order</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Label</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-20">Status</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-24">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for option in cat.options %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2 text-xs text-gray-500">{{ option.display_order }}</td>
                                <td class="px-3 py-2 text-xs font-mono text-gray-900">{{ option.value }}</td>
                                <td class="px-3 py-2 text-xs text-gray-900">{{ option.label }}</td>
                                <td class="px-3 py-2">
                                    {% if option.is_active %}
                                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                    {% else %}
                                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-right text-xs">
                                    <button onclick="openEditModal({{ option.id }}, '{{ option.category }}', '{{ option.value|escapejs }}', '{{ option.label|escapejs }}', {{ option.display_order }}, {{ option.is_active|yesno:'true,false' }})" 
                                            class="text-indigo-600 hover:text-indigo-800 mr-2">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteOption({{ option.id }}, '{{ option.label|escapejs }}')" 
                                            class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-3 py-4 text-center text-xs text-gray-500">
                                    No options found. Click "Add Option" to create one.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Modal -->
<div id="addModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Add Dropdown Option</h3>
                    <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="addForm" onsubmit="submitAddOption(event)" class="p-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_option">
                <input type="hidden" id="add_category" name="category">
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
                        <input type="text" id="add_category_display" readonly class="w-full compact-input border border-gray-300 rounded bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Value <span class="text-red-500">*</span></label>
                        <input type="text" name="value" required class="w-full compact-input border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="e.g., STE, Male, Physical">
                        <p class="text-xs text-gray-500 mt-0.5">Database value (no spaces, lowercase recommended)</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Label <span class="text-red-500">*</span></label>
                        <input type="text" name="label" required class="w-full compact-input border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="e.g., STE, Male, Physical Bullying">
                        <p class="text-xs text-gray-500 mt-0.5">Display text shown to users</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Display Order</label>
                        <input type="number" name="display_order" value="0" class="w-full compact-input border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-0.5">Lower numbers appear first (0 = first)</p>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button type="button" onclick="closeAddModal()" class="px-3 py-1.5 border border-gray-300 rounded text-sm text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Add Option</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Edit Dropdown Option</h3>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="editForm" onsubmit="submitEditOption(event)" class="p-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit_option">
                <input type="hidden" id="edit_option_id" name="option_id">
                <input type="hidden" id="edit_category" name="category">
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
                        <input type="text" id="edit_category_display" readonly class="w-full compact-input border border-gray-300 rounded bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Value <span class="text-red-500">*</span></label>
                        <input type="text" id="edit_value" name="value" required class="w-full compact-input border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Label <span class="text-red-500">*</span></label>
                        <input type="text" id="edit_label" name="label" required class="w-full compact-input border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Display Order</label>
                        <input type="number" id="edit_display_order" name="display_order" class="w-full compact-input border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="edit_is_active" name="is_active" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-xs font-medium text-gray-700">Active</span>
                        </label>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button type="button" onclick="closeEditModal()" class="px-3 py-1.5 border border-gray-300 rounded text-sm text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Store active tab in sessionStorage
function showDropdownTab(category) {
    // Hide all tabs
    document.querySelectorAll('.dropdown-tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.dropdown-tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab
    document.getElementById('tab-' + category).classList.remove('hidden');
    
    // Activate button
    const button = document.querySelector(`[data-tab="${category}"]`);
    if (button) {
        button.classList.add('active', 'border-indigo-500', 'text-indigo-600');
        button.classList.remove('border-transparent', 'text-gray-500');
    }
    
    // Save active tab to sessionStorage
    sessionStorage.setItem('active_dropdown_tab', category);
}

// Restore active tab on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedTab = sessionStorage.getItem('active_dropdown_tab');
    if (savedTab) {
        // Check if the tab exists
        const tabElement = document.getElementById('tab-' + savedTab);
        if (tabElement) {
            showDropdownTab(savedTab);
        }
    }
});

function openAddModal(category, categoryLabel) {
    document.getElementById('add_category').value = category;
    document.getElementById('add_category_display').value = categoryLabel;
    document.getElementById('addForm').reset();
    document.getElementById('add_category').value = category;
    document.getElementById('add_category_display').value = categoryLabel;
    document.getElementById('addModal').classList.remove('hidden');
}

function closeAddModal() {
    document.getElementById('addModal').classList.add('hidden');
    document.getElementById('addForm').reset();
}

function openEditModal(id, category, value, label, displayOrder, isActive) {
    document.getElementById('edit_option_id').value = id;
    document.getElementById('edit_category').value = category;
    document.getElementById('edit_category_display').value = document.querySelector(`[data-tab="${category}"]`).textContent.trim().split('\n')[0];
    document.getElementById('edit_value').value = value;
    document.getElementById('edit_label').value = label;
    document.getElementById('edit_display_order').value = displayOrder;
    document.getElementById('edit_is_active').checked = isActive === 'true' || isActive === true;
    document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editForm').reset();
}

async function submitAddOption(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
        const response = await fetch('{% url "manage_dropdowns" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Save current active tab before reload
            const activeTab = sessionStorage.getItem('active_dropdown_tab') || '{{ category_options.0.code }}';
            sessionStorage.setItem('active_dropdown_tab', activeTab);
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function submitEditOption(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Save current active tab before reload
    const activeTab = sessionStorage.getItem('active_dropdown_tab') || document.getElementById('edit_category').value || '{{ category_options.0.code }}';
    sessionStorage.setItem('active_dropdown_tab', activeTab);
    
    try {
        const response = await fetch('{% url "manage_dropdowns" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteOption(id, label) {
    if (!confirm(`Are you sure you want to delete "${label}"?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('action', 'delete_option');
    formData.append('option_id', id);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    try {
        const response = await fetch('{% url "manage_dropdowns" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Save current active tab before reload
            const activeTab = sessionStorage.getItem('active_dropdown_tab') || '{{ category_options.0.code }}';
            sessionStorage.setItem('active_dropdown_tab', activeTab);
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
