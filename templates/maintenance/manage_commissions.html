{% extends 'base.html' %}
{% load static %}

{% block title %}3 Commission Maintenance - SIRMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-4xl font-bold text-indigo-700 mb-2">⚖️ 3 Commission Maintenance</h1>
        <p class="text-gray-600">Manage commission levels and their associated interventions for VRF (Values Reflective Formation) cases</p>
    </div>

    <!-- Commission Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        {% for item in commissions_with_stats %}
        <div class="bg-white rounded-lg shadow-md border-2 {% if item.commission.level == '1st' %}border-blue-300{% elif item.commission.level == '2nd' %}border-yellow-300{% else %}border-red-300{% endif %} overflow-hidden">
            <!-- Commission Header -->
            <div class="bg-gradient-to-r {% if item.commission.level == '1st' %}from-blue-600 to-blue-700{% elif item.commission.level == '2nd' %}from-yellow-600 to-yellow-700{% else %}from-red-600 to-red-700{% endif %} px-6 py-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold" id="commission-name-{{ item.commission.id }}">{{ item.commission.name }}</h3>
                        <p class="text-sm text-white/90 mt-1" id="commission-desc-{{ item.commission.id }}">{{ item.commission.description|truncatewords:10 }}</p>
                    </div>
                    <div class="bg-white/20 rounded-full p-3 ml-2">
                        <i class="fas fa-gavel text-2xl"></i>
                    </div>
                </div>
                <button onclick="editCommission({{ item.commission.id }}, '{{ item.commission.name|escapejs }}', '{{ item.commission.description|escapejs }}', {{ item.commission.order }})" 
                        class="mt-2 text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors">
                    <i class="fas fa-edit mr-1"></i> Edit Commission
                </button>
            </div>

            <!-- Statistics -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div>
                        <div class="text-2xl font-bold text-gray-900">{{ item.stats.total_cases|default:0 }}</div>
                        <div class="text-xs text-gray-600">Total Cases</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-600">{{ item.stats.completed|default:0 }}</div>
                        <div class="text-xs text-gray-600">Completed</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-yellow-600">{{ item.stats.pending|default:0 }}</div>
                        <div class="text-xs text-gray-600">Pending</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-blue-600">{{ item.stats.scheduled|default:0 }}</div>
                        <div class="text-xs text-gray-600">Scheduled</div>
                    </div>
                </div>
            </div>

            <!-- Interventions -->
            <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-gray-700 flex items-center">
                        <i class="fas fa-tasks mr-2 text-indigo-600"></i>
                        Available Interventions
                    </h4>
                    <button onclick="showAddInterventionModal({{ item.commission.id }})" 
                            class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded">
                        <i class="fas fa-plus mr-1"></i> Add
                    </button>
                </div>
                <ul class="space-y-2" id="interventions-list-{{ item.commission.id }}">
                    {% for intervention in item.interventions %}
                    <li class="flex items-start justify-between group">
                        <div class="flex items-start space-x-2 flex-1">
                            <i class="fas fa-check-circle text-green-500 mt-0.5 flex-shrink-0"></i>
                            <span class="text-sm text-gray-700">{{ intervention.name }}</span>
                        </div>
                        <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editIntervention({{ intervention.id }}, '{{ intervention.name|escapejs }}', '{{ intervention.description|escapejs }}', {{ intervention.order }})" 
                                    class="text-xs text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteIntervention({{ intervention.id }}, '{{ intervention.name|escapejs }}')" 
                                    class="text-xs text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                    {% empty %}
                    <li class="text-sm text-gray-500 italic">No interventions added yet</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- View Cases Button -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
                <a href="{% url 'all_reports' %}?search={{ item.commission.level }} Commission" 
                   class="block w-full text-center bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    View {{ item.commission.name }} Cases
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Commission Information Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h2 class="text-xl font-bold text-gray-900">
                <i class="fas fa-info-circle text-indigo-600 mr-2"></i>
                Commission Level Details
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commission Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interventions</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statistics</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in commissions_with_stats %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="px-3 py-1 rounded-full text-sm font-bold text-white {% if item.commission.level == '1st' %}bg-blue-600{% elif item.commission.level == '2nd' %}bg-yellow-600{% else %}bg-red-600{% endif %}">
                                    {{ item.commission.name }}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">{{ item.commission.description }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-700">
                                <ul class="list-disc list-inside space-y-1">
                                    {% for intervention in item.interventions %}
                                    <li>{{ intervention.name }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm">
                                <div class="flex items-center space-x-4">
                                    <div class="text-center">
                                        <div class="font-bold text-gray-900">{{ item.stats.total_cases|default:0 }}</div>
                                        <div class="text-xs text-gray-500">Total</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-bold text-yellow-600">{{ item.stats.pending|default:0 }}</div>
                                        <div class="text-xs text-gray-500">Pending</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-bold text-blue-600">{{ item.stats.scheduled|default:0 }}</div>
                                        <div class="text-xs text-gray-500">Scheduled</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-bold text-green-600">{{ item.stats.completed|default:0 }}</div>
                                        <div class="text-xs text-gray-500">Completed</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Information Section -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-bold text-blue-900 mb-3 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            About Commission Levels
        </h3>
        <div class="space-y-2 text-sm text-blue-800">
            <p><strong>1st Commission:</strong> Used for first-time offenses. Focuses on initial intervention and guidance.</p>
            <p><strong>2nd Commission:</strong> Used for repeat offenses. Includes VRF (Values Reflective Formation) as an option.</p>
            <p><strong>3rd Commission:</strong> Used for multiple repeat offenses. Maximum intervention level with VRF required.</p>
            <p class="mt-3 text-xs text-blue-700">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                <strong>Note:</strong> Changes to commissions and interventions will automatically update in case evaluation forms. Commission levels are assigned by Guidance Counselors during case evaluation.
            </p>
        </div>
    </div>
</div>

<!-- Edit Commission Modal -->
<div id="editCommissionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-900">Edit Commission</h3>
        </div>
        <form id="editCommissionForm" class="p-6 space-y-4">
            <input type="hidden" id="editCommissionId" name="commission_id">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Commission Name</label>
                <input type="text" id="editCommissionName" name="name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="editCommissionDescription" name="description" rows="3" required
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Display Order</label>
                <input type="number" id="editCommissionOrder" name="order" min="1" max="3" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex space-x-3 pt-4">
                <button type="button" onclick="closeEditCommissionModal()" 
                        class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Intervention Modal -->
<div id="addInterventionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-900">Add Intervention</h3>
        </div>
        <form id="addInterventionForm" class="p-6 space-y-4">
            <input type="hidden" id="addInterventionCommissionId" name="commission_id">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Intervention Name <span class="text-red-500">*</span></label>
                <input type="text" id="addInterventionName" name="name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                       placeholder="e.g., Parent Conference">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                <textarea id="addInterventionDescription" name="description" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Display Order</label>
                <input type="number" id="addInterventionOrder" name="order" min="1" value="1" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex space-x-3 pt-4">
                <button type="button" onclick="closeAddInterventionModal()" 
                        class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Add Intervention
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Intervention Modal -->
<div id="editInterventionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-900">Edit Intervention</h3>
        </div>
        <form id="editInterventionForm" class="p-6 space-y-4">
            <input type="hidden" id="editInterventionId" name="intervention_id">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Intervention Name <span class="text-red-500">*</span></label>
                <input type="text" id="editInterventionName" name="name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                <textarea id="editInterventionDescription" name="description" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Display Order</label>
                <input type="number" id="editInterventionOrder" name="order" min="1" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex space-x-3 pt-4">
                <button type="button" onclick="closeEditInterventionModal()" 
                        class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Edit Commission
function editCommission(id, name, description, order) {
    document.getElementById('editCommissionId').value = id;
    document.getElementById('editCommissionName').value = name;
    document.getElementById('editCommissionDescription').value = description;
    document.getElementById('editCommissionOrder').value = order;
    document.getElementById('editCommissionModal').classList.remove('hidden');
}

function closeEditCommissionModal() {
    document.getElementById('editCommissionModal').classList.add('hidden');
}

document.getElementById('editCommissionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const commissionId = formData.get('commission_id');
    
    try {
        const response = await fetch(`{% url 'update_commission' 0 %}`.replace('0', commissionId), {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Add Intervention
function showAddInterventionModal(commissionId) {
    document.getElementById('addInterventionCommissionId').value = commissionId;
    document.getElementById('addInterventionName').value = '';
    document.getElementById('addInterventionDescription').value = '';
    document.getElementById('addInterventionOrder').value = '1';
    document.getElementById('addInterventionModal').classList.remove('hidden');
}

function closeAddInterventionModal() {
    document.getElementById('addInterventionModal').classList.add('hidden');
}

document.getElementById('addInterventionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const commissionId = formData.get('commission_id');
    
    try {
        const response = await fetch(`{% url 'add_commission_intervention' 0 %}`.replace('0', commissionId), {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Edit Intervention
function editIntervention(id, name, description, order) {
    document.getElementById('editInterventionId').value = id;
    document.getElementById('editInterventionName').value = name;
    document.getElementById('editInterventionDescription').value = description || '';
    document.getElementById('editInterventionOrder').value = order;
    document.getElementById('editInterventionModal').classList.remove('hidden');
}

function closeEditInterventionModal() {
    document.getElementById('editInterventionModal').classList.add('hidden');
}

document.getElementById('editInterventionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const interventionId = formData.get('intervention_id');
    
    try {
        const response = await fetch(`{% url 'update_commission_intervention' 0 %}`.replace('0', interventionId), {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Delete Intervention
function deleteIntervention(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch(`{% url 'delete_commission_intervention' 0 %}`.replace('0', id), {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock %}
