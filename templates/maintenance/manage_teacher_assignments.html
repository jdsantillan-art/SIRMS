{% extends 'base.html' %}
{% load static %}

{% block title %}Teacher Assignment Management - SIRMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold text-green-700 mb-2">üë®‚Äçüè´ Teacher Assignment Management</h1>
            <p class="text-gray-600">Manage teacher assignments per academic year</p>
        </div>
        <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
            <i class="fas fa-plus"></i> Add Assignment
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <select name="academic_year" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Academic Years</option>
                {% for year in academic_years %}
                <option value="{{ year }}" {% if academic_year_filter == year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
            <input type="text" name="teacher" value="{{ teacher_filter }}" placeholder="Search by teacher name..." 
                   class="px-4 py-2 border border-gray-300 rounded-lg">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-search"></i> Filter
            </button>
        </form>
    </div>

    <!-- Assignments Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-purple-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Teacher</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Curriculum</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Track</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Grade</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Section</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Academic Year</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for assignment in assignments %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ assignment.teacher_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ assignment.curriculum.name|default:"‚Äî" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ assignment.track_code }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ assignment.grade_level }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ assignment.section_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ assignment.academic_year }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if assignment.is_active %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editAssignment({{ assignment.id }})" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deactivateAssignment({{ assignment.id }})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-ban"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">No assignments found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Assignment Modal -->
<div id="addModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Add Teacher Assignment</h3>
                    <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <form id="addAssignmentForm" onsubmit="submitAddAssignment(event)">
                    {% csrf_token %}
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teacher Name <span class="text-red-500">*</span></label>
                            <input type="text" name="teacher_name" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Enter teacher name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year <span class="text-red-500">*</span></label>
                            <input type="text" name="academic_year" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., 2024-2025" pattern="\d{4}-\d{4}">
                            <p class="text-xs text-gray-500 mt-1">Format: YYYY-YYYY (e.g., 2024-2025)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Curriculum <span class="text-red-500">*</span></label>
                            <select name="curriculum_id" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Curriculum</option>
                                {% for curriculum in curricula %}
                                <option value="{{ curriculum.id }}">{{ curriculum.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Track <span class="text-red-500">*</span></label>
                            <select name="track_code" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Track</option>
                                <option value="STE">STE</option>
                                <option value="SPA">SPA</option>
                                <option value="ICT">ICT</option>
                                <option value="RBEC">RBEC</option>
                                <option value="STVEP">STVEP</option>
                                <option value="STEM">STEM</option>
                                <option value="Arts & Design">Arts & Design</option>
                                <option value="TVL ‚Äì ICT">TVL ‚Äì ICT</option>
                                <option value="TVL ‚Äì SMAW">TVL ‚Äì SMAW</option>
                                <option value="TVL ‚Äì EIM">TVL ‚Äì EIM</option>
                                <option value="TVL ‚Äì Dressmaking">TVL ‚Äì Dressmaking</option>
                                <option value="TVL ‚Äì FBS">TVL ‚Äì FBS</option>
                                <option value="TVL ‚Äì Bread & Pastry">TVL ‚Äì Bread & Pastry</option>
                                <option value="TVL ‚Äì CSS">TVL ‚Äì CSS</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Grade Level <span class="text-red-500">*</span></label>
                            <select name="grade_level" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Grade</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Section <span class="text-red-500">*</span></label>
                            <input type="text" name="section_name" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., Section 1">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeAddModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Assignment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Assignment Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Edit Teacher Assignment</h3>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <form id="editAssignmentForm" onsubmit="submitUpdateAssignment(event)">
                    {% csrf_token %}
                    <input type="hidden" name="assignment_id" id="edit_assignment_id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teacher Name <span class="text-red-500">*</span></label>
                            <input type="text" name="teacher_name" id="edit_teacher_name" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Enter teacher name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year <span class="text-red-500">*</span></label>
                            <input type="text" name="academic_year" id="edit_academic_year" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., 2024-2025" pattern="\d{4}-\d{4}">
                            <p class="text-xs text-gray-500 mt-1">Format: YYYY-YYYY (e.g., 2024-2025)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Curriculum <span class="text-red-500">*</span></label>
                            <select name="curriculum_id" id="edit_curriculum_id" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Curriculum</option>
                                {% for curriculum in curricula %}
                                <option value="{{ curriculum.id }}">{{ curriculum.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Track <span class="text-red-500">*</span></label>
                            <select name="track_code" id="edit_track_code" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Track</option>
                                <option value="STE">STE</option>
                                <option value="SPA">SPA</option>
                                <option value="ICT">ICT</option>
                                <option value="RBEC">RBEC</option>
                                <option value="STVEP">STVEP</option>
                                <option value="STEM">STEM</option>
                                <option value="Arts & Design">Arts & Design</option>
                                <option value="TVL ‚Äì ICT">TVL ‚Äì ICT</option>
                                <option value="TVL ‚Äì SMAW">TVL ‚Äì SMAW</option>
                                <option value="TVL ‚Äì EIM">TVL ‚Äì EIM</option>
                                <option value="TVL ‚Äì Dressmaking">TVL ‚Äì Dressmaking</option>
                                <option value="TVL ‚Äì FBS">TVL ‚Äì FBS</option>
                                <option value="TVL ‚Äì Bread & Pastry">TVL ‚Äì Bread & Pastry</option>
                                <option value="TVL ‚Äì CSS">TVL ‚Äì CSS</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Grade Level <span class="text-red-500">*</span></label>
                            <select name="grade_level" id="edit_grade_level" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Grade</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Section <span class="text-red-500">*</span></label>
                            <input type="text" name="section_name" id="edit_section_name" required class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., Section 1">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Update Assignment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function openAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
}

function closeAddModal() {
    document.getElementById('addModal').classList.add('hidden');
    document.getElementById('addAssignmentForm').reset();
}

async function submitAddAssignment(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{% url "add_teacher_assignment" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Assignment created successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error creating assignment: ' + error.message);
    }
}

async function editAssignment(id) {
    try {
        const response = await fetch(`{% url 'edit_teacher_assignment' 0 %}`.replace('0', id), {
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const assignment = data.assignment;
            
            // Populate edit form
            document.getElementById('edit_assignment_id').value = assignment.id;
            document.getElementById('edit_teacher_name').value = assignment.teacher_name;
            document.getElementById('edit_curriculum_id').value = assignment.curriculum_id || '';
            document.getElementById('edit_track_code').value = assignment.track_code;
            document.getElementById('edit_grade_level').value = assignment.grade_level;
            document.getElementById('edit_section_name').value = assignment.section_name;
            document.getElementById('edit_academic_year').value = assignment.academic_year;
            
            // Show edit modal
            document.getElementById('editModal').classList.remove('hidden');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error loading assignment: ' + error.message);
    }
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editAssignmentForm').reset();
}

async function submitUpdateAssignment(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const assignmentId = formData.get('assignment_id');
    
    try {
        const response = await fetch(`{% url 'update_teacher_assignment' 0 %}`.replace('0', assignmentId), {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Assignment updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error updating assignment: ' + error.message);
    }
}

function deactivateAssignment(id) {
    if (confirm('Are you sure you want to deactivate this assignment?')) {
        // TODO: Implement deactivate functionality
        alert('Deactivate functionality coming soon');
    }
}

</script>
{% endblock %}



